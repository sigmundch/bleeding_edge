<!DOCTYPE html>

<!-- Copyright (c) 2012, the Dart project authors.  Please see the AUTHORS file
     for details. All rights reserved. Use of this source code is governed by a
     BSD-style license that can be found in the LICENSE file. -->

<!-- This file contains components as they might be written for input to the
     components/template compiler. The actual components used in this app live
     in scripts/components.dart and components/components.html. -->

<html>
  <head>
    <title>TodoMVC Components</title>
  </head>
  <body>
    <element extends="li" name="x-todo-list-element" apply-author-styles>
      <template>
        <div class="view">
          <input class="todo-toggle" type="checkbox" >
          <label></label>
          <button class="todo-destroy"></button>
        </div>
        <input class="todo-edit todo-edit-static" value="">
      </template>
      <script type='application/dart'>
        final ShadowRoot _shadowRoot;
        Todo _todo;
        Todos model;
        InputElement _input;
        InputElement _toggle;
        ButtonElement _destroy;
        LabelElement _label;
        DivElement _nonEditingView;

        void set todo(t) {
          _todo = t;
          _render();
        }

        Todo get todo => _todo;

        // set appropriate classes to view mode
        void _render() {
          _label.innerHTML = todo.value;
          _input.attributes['value'] = todo.value;
          _nonEditingView.classes = ['view'];
          _input.classes.remove('todo-edit-editing');
          _input.classes.add('todo-edit-static');
        }

        void complete() {
          _label.classes.add('completed');
          _toggle.checked = true;
        }

        void uncomplete() {
          _label.classes.remove('completed');
          _toggle.checked = false;
        }

        void created(ShadowRoot shadowRoot) {
          _shadowRoot = shadowRoot;
          _input = _shadowRoot.query('.todo-edit');
          _label = _shadowRoot.query('label');
          _toggle = _shadowRoot.query('.todo-toggle');
          _nonEditingView = _shadowRoot.query('.view');
          _destroy = _shadowRoot.query('.todo-destroy');
        }

        void inserted() {
          _nonEditingView.on.doubleClick.add((event) {
            _nonEditingView.classes = ['editing'];
            _input.classes.remove('todo-edit-static');
            _input.classes.add('todo-edit-editing');
            _input.select();
          });
          _destroy.on.click.add((event) {
            model.removeTodo(todo);
          });
          _toggle.on.change.add((event) {
            if (_toggle.checked) {
              model.complete(todo);
            } else {
              model.uncomplete(todo);
            }
          });
          // TODO(samhop): This event listener should only be attached when the
          // todo is in editing mode. 
          _input.on.keyPress.add((event) {
            if (event.keyCode == ENTER_KEY) { _saveTodo(); }
          });
          _input.on.blur.add((event) => _saveTodo());
          // TODO(samhop): These listeners should be detached when the component is
          // removed; otherwise presumably it won't get gc'd. 
          model.on.completed.add((todo) {
            if (todo == this.todo) {
              complete();
            }
          });
          model.on.uncompleted.add((todo) {
            if (todo == this.todo) {
              uncomplete();
            }
          });
          model.on.removed.add((todo) {
            if (todo == this.todo) {
              this.remove();
            }
          });
        }
      </script>
    </element>

    <element extends="div" name="x-todo-footer" apply-author-styles>
      <template>
        <p>Double-click to edit a todo</p>
        <p>Created by the <a href="http://www.dartlang.org">Dart</a> team</p>
        <p>Part of <a href="http://todomvc.com">TodoMVC</a></p>
      </template>
    </element>

    <element extends="div" name="x-todo-list" apply-author-styles>
      <template>
        <style scoped>
          #footer {
           font: 14px 'Helvetica Neue', Helvetica, Arial, sans-serif;
            line-height: 1.4em;
          }
        </style>
        <input id="toggle-all" type="checkbox">
        <label for="toggle-all">Mark all as complete</label>
        <ul id="todo-list">
        </ul>
        <footer id="footer">
          <span id="todo-count"></span>
          <button id="clear-completed"></button>
        </footer>
      </template>
      <script type="application/javascript">
        ShadowRoot _shadowRoot;
        Todos _model;
        // dart:html has no FooterElement
        Element _footer;
        ButtonElement _clearCompleted;

        void addTodo(Todo todo) {
          // possible order of operations issue with the model binding/rendering
          var todoComponent = new TodoListElement();
          todoComponent.todo = todo;
          todoComponent.model = model;
          _shadowRoot.query('#todo-list').nodes.add(todoComponent);
        }

        void set model(Todos model) {
          this._model = model;
          model.on.added.addAll([addTodo, updateCount]);
          model.on.removed.add(updateCount);
          model.on.completed.add(updateCount);
          model.on.uncompleted.add(updateCount);
        }

        // We take a Todo argument so that updateCount can be a TodoCallback
        void updateCount(Todo todo) {
          // TODO(samhop): Not clear how to make this less hacky, since the
          // component doesn't have a lifecycle event for "model is hooked up"
          if (model == null || model._todos.length == 0) {
            _footer.classes.add('no-todos');
          } else {
            var uncomplete = model.remaining;
            _footer.classes.remove('no-todos');
            if (uncomplete == 1) {
              _footer.query('#todo-count').innerHTML =
                  '<strong>1</strong> item left';
            } else {
              _footer.query('#todo-count').innerHTML =
                  '<strong>$uncomplete</strong> items left';
            }
            _clearCompleted.innerHTML =
                 'Clear completed '
                 '(${model._todos.length - model.remaining})';
          }
        }

        Todos get model => _model;

        void created(ShadowRoot shadowRoot) {
          _shadowRoot = shadowRoot;
          _footer = _shadowRoot.query('#footer');
          _clearCompleted = _shadowRoot.query('#clear-completed');
        }

        void inserted() {
          updateCount(null);
          var toggleAll = _shadowRoot.query('#toggle-all');
          toggleAll.on.change.add((event) {
            if (toggleAll.checked) {
              model.completeAll();
            } else {
              model.uncompleteAll();
            }
          });
          _shadowRoot.query('#clear-completed').on.click.add((event) {
            model.clearCompleted();
          });
        }

        // TODO(samhop): Expose current todo list as a data attribute of the
        // TodoList component.
        void attributeChanged(String name, String oldValue, String newValue) { }

        void removed() { }
      }
      </script>

    </element>

    <element extends="div" name="x-new-todo" apply-author-styles>
      <template>
        <input id="new-todo" placeholder="What needs to be done?" autofocus>
      </template>
      <script type='application/javascript'>
        ShadowRoot _shadowRoot;
        Todos model;
        
        void created(ShadowRoot shadowRoot) { 
          _shadowRoot = shadowRoot;
        }
        void inserted() {
          _shadowRoot.on.keyPress.add((event) {
            if (event.keyCode == ENTER_KEY) {
              var input = _shadowRoot.query('#new-todo');
              var trimmedStr = input.value.trim();
              if (trimmedStr != '') {
                model.addTodo(new Todo(trimmedStr));
                input.value = '';
              }
            }
          });
        }
        void attributeChanged(String name, String oldValue, String newValue) { }
        void removed() { }
      </script>
    </element>
  </body>
</html>
